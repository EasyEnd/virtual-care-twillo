<!DOCTYPE html>
<html>
  <head>
    <title>Owl Hospital Telemedicine App</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <h1>ðŸ¦‰ Welcome to Owl Hospital Telemedicine ðŸ¦‰</h1>
  </body>
  <button id="join-button">Join Room</button>
  <button id="leave-button" class="hidden">Leave Room</button>
  <div id="waiting-room" class="hidden">
    <p>Thanks! Your provider will be with you shortly.</p>
  </div>
  <div id="local-media-container"></div>
  <div id="media-container"></div>
  <script src="./index.js"></script>
  <script src="//media.twiliocdn.com/sdk/js/video/releases/2.3.0/twilio-video.min.js"></script>
  <script>
    // TODO:
    // make sure the audio works!
    const providerIdentity = "provider";

    async function onJoinButtonClick(event) {
      await joinRoom(event, "patient");
      const waitingRoom = document.getElementById("waiting-room");

      // is there a doctor in the house??
      if (
        !isProviderPresent(room.participants) &&
        waitingRoom.classList.contains("hidden")
      ) {
        waitingRoom.classList.toggle("hidden");
      }

      // if the provider joins and the waiting room is visible, hide it
      room.on("participantConnected", (participant) => {
        if (participant.identity === providerIdentity) {
          waitingRoom.classList.toggle(
            "hidden",
            !waitingRoom.classList.contains("hidden")
          );
        }
      });

      // if the provider disconnects and the waiting room is invisible, show it
      room.on("participantDisconnected", (participant) => {
        if (
          participant.identity === providerIdentity &&
          waitingRoom.classList.contains("hidden")
        ) {
          waitingRoom.innerText = "Your provider has disconnected.";
          waitingRoom.classList.toggle("hidden");
        }
      });

      // room.on("disconnected", () => {
      //   waitingRoom.classList.toggle("hidden");
      // });
      // TODO:
      // make this an IIFE
      event.preventDefault();
    }

    isProviderPresent = (participantMap) => {
      for (const participant of participantMap.values()) {
        if (participant.identity === providerIdentity) {
          return true;
        }
      }
      return false;
    };

    const button = document.getElementById("join-button");
    button.addEventListener("click", onJoinButtonClick);

    const leaveButton = document.getElementById("leave-button");
    leaveButton.addEventListener("click", onLeaveButtonClick);
  </script>
</html>
